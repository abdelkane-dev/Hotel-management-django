{% extends 'hotel/base.html' %}
{% load static %}

{% block page_title %}
<i class="fas fa-bell"></i>
<span>Notifications</span>
{% endblock %}

{% block extra_css %}
<style>
.notification-card {
    border-left: 4px solid #dee2e6;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
}
.notification-card:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.notification-card.non-lue {
    border-left-color: #ffc107;
    background-color: #fffdf7;
}
.notification-card.critique {
    border-left-color: #dc3545;
    background-color: #fdf7f7;
}
.notification-card.haute {
    border-left-color: #fd7e14;
    background-color: #fef9f5;
}
.notification-card.normale {
    border-left-color: #0d6efd;
    background-color: #f7faff;
}
.notification-card.basse {
    border-left-color: #6c757d;
    background-color: #f8f9fa;
}

.priority-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}
.type-icon {
    font-size: 1.2rem;
    width: 40px;
    text-align: center;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 1rem;
}

.notification-actions {
    opacity: 0.7;
    transition: opacity 0.3s ease;
}
.notification-card:hover .notification-actions {
    opacity: 1;
}

.quick-action-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec statistiques améliorées -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-bell text-primary me-2"></i>
                        Centre de Notifications
                    </h2>
                    <small class="text-muted">Gérez vos alertes et informations système</small>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="refreshNotifications()">
                        <i class="fas fa-sync-alt me-1"></i>Actualiser
                    </button>
                    <a href="{% url 'notification_marquer_toutes_lues' %}" class="btn btn-sm btn-success" id="mark-all">
                        <i class="fas fa-check-double me-1"></i>Tout marquer comme lues
                    </a>
                </div>
            </div>

            <!-- Statistiques améliorées -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h4 class="mb-1">{{ stats.total }}</h4>
                        <small>Total Notifications</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h4 class="mb-1">{{ stats.non_lues }}</h4>
                            <small>Non lues</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h4 class="mb-1">{{ stats.non_traitees }}</h4>
                            <small>Non traitées</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4 class="mb-1">{{ stats.critiques|default:0 }}</h4>
                            <small>Critiques</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres améliorés -->
    <div class="filter-section">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold">
                    <i class="fas fa-filter me-1"></i>Type
                </label>
                <select class="form-select form-select-sm" id="filterType" onchange="applyFilters()">
                    <option value="">Tous les types</option>
                    <option value="reservation">Réservations</option>
                    <option value="paiement">Paiements</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="inventaire">Inventaire</option>
                    <option value="contact_client">Messages Clients</option>
                    <option value="systeme">Système</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">
                    <i class="fas fa-exclamation-triangle me-1"></i>Priorité
                </label>
                <select class="form-select form-select-sm" id="filterPriority" onchange="applyFilters()">
                    <option value="">Toutes les priorités</option>
                    <option value="critique">Critique</option>
                    <option value="haute">Haute</option>
                    <option value="normale">Normale</option>
                    <option value="basse">Basse</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">
                    <i class="fas fa-eye me-1"></i>Statut
                </label>
                <select class="form-select form-select-sm" id="filterStatus" onchange="applyFilters()">
                    <option value="">Tous les statuts</option>
                    <option value="non_lue">Non lues</option>
                    <option value="lue">Lues</option>
                    <option value="non_traitee">Non traitées</option>
                    <option value="traitee">Traitées</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-sm btn-outline-secondary w-100" onclick="resetFilters()">
                    <i class="fas fa-redo me-1"></i>Réinitialiser
                </button>
            </div>
        </div>
    </div>

    <!-- Actions groupées -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="markSelectedAsRead()">
                    <i class="fas fa-check me-1"></i>Marquer sélectionnées comme lues
                </button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="markSelectedAsProcessed()">
                    <i class="fas fa-check-circle me-1"></i>Marquer sélectionnées comme traitées
                </button>
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="archiveSelected()">
                    <i class="fas fa-archive me-1"></i>Archiver sélectionnées
                </button>
            </div>
        </div>
    </div>

    <!-- Liste des notifications améliorée -->
    <div class="row">
        <div class="col-12">
            {% for n in notifications %}
            <div class="card notification-card {% if not n.lue %}non-lue{% endif %} {{ n.priorite }}" 
                 data-type="{{ n.type_notification }}" 
                 data-priority="{{ n.priorite }}" 
                 data-status="{% if not n.lue %}non_lue{% elif not n.traitee %}non_traitee{% else %}traitee{% endif %}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Icône et type -->
                        <div class="col-auto">
                            <div class="type-icon">
                                {% if n.type_notification == 'reservation' %}
                                    <i class="fas fa-calendar-check text-primary"></i>
                                {% elif n.type_notification == 'paiement' %}
                                    <i class="fas fa-credit-card text-success"></i>
                                {% elif n.type_notification == 'maintenance' %}
                                    <i class="fas fa-tools text-warning"></i>
                                {% elif n.type_notification == 'contact_client' %}
                                    <i class="fas fa-envelope text-info"></i>
                                {% elif n.type_notification == 'inventaire' %}
                                    <i class="fas fa-boxes text-info"></i>
                                {% elif n.type_notification == 'systeme' %}
                                    <i class="fas fa-cog text-secondary"></i>
                                {% else %}
                                    <i class="fas fa-bell text-muted"></i>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Contenu principal -->
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <h6 class="mb-0">{{ n.get_type_notification_display }}</h6>
                                        {% if n.priorite == 'critique' %}
                                            <span class="badge bg-danger priority-badge">CRITIQUE</span>
                                        {% elif n.priorite == 'haute' %}
                                            <span class="badge bg-warning priority-badge">HAUTE</span>
                                        {% elif n.priorite == 'normale' %}
                                            <span class="badge bg-primary priority-badge">NORMALE</span>
                                        {% else %}
                                            <span class="badge bg-secondary priority-badge">BASSE</span>
                                        {% endif %}
                                        {% if not n.lue %}
                                            <span class="badge bg-warning"><i class="fas fa-envelope me-1"></i>Non lue</span>
                                        {% endif %}
                                        {% if not n.traitee %}
                                            <span class="badge bg-info"><i class="fas fa-clock me-1"></i>En attente</span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-2">{{ n.message|truncatechars:150 }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>{{ n.date_creation|timesince }} 
                                        {% if n.objet_lie %}
                                        | <i class="fas fa-link me-1"></i>{{ n.objet_lie }}
                                        {% endif %}
                                    </small>
                                </div>

                                <!-- Actions -->
                                <div class="notification-actions">
                                    <div class="btn-group-vertical btn-group-sm">
                                        {% if n.objet_lie_url %}
                                        <a href="{{ n.objet_lie_url }}" class="btn btn-outline-primary quick-action-btn" title="Voir l'objet">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                        {% endif %}
                                        {% if n.type_notification == 'contact_client' %}
                                        <button class="btn btn-info quick-action-btn" 
                                                onclick="replyToClientMessage({{ n.id }})" 
                                                title="Répondre au client">
                                            <i class="fas fa-reply"></i>
                                        </button>
                                        {% endif %}
                                        {% if not n.lue %}
                                        <button class="btn btn-primary quick-action-btn mark-read" 
                                                data-url="{% url 'notification_marquer_lue' n.id %}" 
                                                title="Marquer comme lue">
                                            <i class="fas fa-envelope-open"></i>
                                        </button>
                                        {% endif %}
                                        {% if not n.traitee %}
                                        <button class="btn btn-success quick-action-btn mark-processed" 
                                                data-url="{% url 'notification_marquer_traitee' n.id %}" 
                                                title="Marquer comme traitée">
                                            <i class="fas fa-check-circle"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-secondary quick-action-btn" 
                                                onclick="showNotificationDetails({{ n.id }})" 
                                                title="Voir les détails">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Checkbox pour sélection -->
                        <div class="col-auto">
                            <input type="checkbox" class="form-check-input notification-checkbox" value="{{ n.id }}">
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Aucune notification trouvée</h5>
                <p class="text-muted">Vous êtes à jour avec toutes vos notifications !</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Pagination améliorée -->
    {% if notifications.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if notifications.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ notifications.previous_page_number }}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in notifications.paginator.page_range %}
                {% if notifications.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}

            {% if notifications.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ notifications.next_page_number }}">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ notifications.paginator.num_pages }}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
        <div class="text-center mt-2">
            <small class="text-muted">
                Page {{ notifications.number }} sur {{ notifications.paginator.num_pages }} 
                ({{ notifications.paginator.count }} notifications au total)
            </small>
        </div>
    </nav>
    {% endif %}
</div>

<!-- Modal pour détails de notification -->
<div class="modal fade" id="notificationDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Détails de la notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="notificationDetailContent">
                <!-- Contenu chargé via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour répondre aux messages clients -->
<div class="modal fade" id="replyToClientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-reply me-2"></i>
                    Répondre au message client
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="clientMessageDetails">
                    <!-- Détails du message client -->
                </div>
                <hr>
                <form id="replyForm">
                    {% csrf_token %}
                    <input type="hidden" id="messageId" name="messageId">
                    <div class="mb-3">
                        <label class="form-label">Réponse au client</label>
                        <textarea class="form-control" id="reponseText" name="reponse" rows="6" 
                                  placeholder="Tapez votre réponse ici..." required></textarea>
                        <small class="text-muted">Cette réponse sera envoyée par email au client.</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="markAsResolved" checked>
                            <label class="form-check-label" for="markAsResolved">
                                Marquer le message comme résolu après envoi
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="sendReplyToClient()">
                    <i class="fas fa-paper-plane me-1"></i>Envoyer la réponse
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Helper pour CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Fonctions existantes améliorées
    document.querySelectorAll('.mark-read').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const url = btn.dataset.url;
            const res = await fetch(url, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
            if (res.ok) {
                // Animation de confirmation
                btn.closest('.notification-card').style.opacity = '0.5';
                setTimeout(() => location.reload(), 500);
            }
        });
    });

    document.querySelectorAll('.mark-processed').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const url = btn.dataset.url;
            const res = await fetch(url, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
            if (res.ok) {
                btn.closest('.notification-card').style.opacity = '0.5';
                setTimeout(() => location.reload(), 500);
            }
        });
    });

    const markAllBtn = document.getElementById('mark-all');
    if (markAllBtn) {
        markAllBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const url = markAllBtn.getAttribute('href');
            const res = await fetch(url, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
            if (res.ok) location.reload();
        });
    }

    // Nouvelles fonctions intelligentes
    function refreshNotifications() {
        const btn = event.target.closest('button');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualisation...';
        btn.disabled = true;
        
        setTimeout(() => {
            location.reload();
        }, 1000);
    }

    function applyFilters() {
        const type = document.getElementById('filterType').value;
        const priority = document.getElementById('filterPriority').value;
        const status = document.getElementById('filterStatus').value;
        
        const cards = document.querySelectorAll('.notification-card');
        cards.forEach(card => {
            let show = true;
            
            if (type && card.dataset.type !== type) show = false;
            if (priority && card.dataset.priority !== priority) show = false;
            if (status && card.dataset.status !== status) show = false;
            
            card.style.display = show ? 'block' : 'none';
        });
        
        // Mettre à jour le compteur visible
        updateVisibleCount();
    }

    function resetFilters() {
        document.getElementById('filterType').value = '';
        document.getElementById('filterPriority').value = '';
        document.getElementById('filterStatus').value = '';
        
        document.querySelectorAll('.notification-card').forEach(card => {
            card.style.display = 'block';
        });
        
        updateVisibleCount();
    }

    function updateVisibleCount() {
        const visible = document.querySelectorAll('.notification-card[style="display: block;"], .notification-card:not([style*="display: none"])').length;
        const total = document.querySelectorAll('.notification-card').length;
        
        // Afficher un message si aucun résultat
        if (visible === 0 && total > 0) {
            let message = document.getElementById('noResultsMessage');
            if (!message) {
                message = document.createElement('div');
                message.id = 'noResultsMessage';
                message.className = 'text-center py-4';
                message.innerHTML = `
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <p class="text-muted">Aucune notification ne correspond à vos filtres</p>
                `;
                document.querySelector('.col-12').appendChild(message);
            }
        } else {
            const message = document.getElementById('noResultsMessage');
            if (message) message.remove();
        }
    }

    function getSelectedNotifications() {
        const checkboxes = document.querySelectorAll('.notification-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    async function markSelectedAsRead() {
        const selected = getSelectedNotifications();
        if (selected.length === 0) {
            alert('Veuillez sélectionner au moins une notification');
            return;
        }
        
        const csrfToken = getCookie('csrftoken');
        let successCount = 0;
        
        for (const id of selected) {
            try {
                const res = await fetch(`/notifications/${id}/marquer-lue/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrfToken}
                });
                if (res.ok) successCount++;
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        if (successCount > 0) {
            location.reload();
        }
    }

    async function markSelectedAsProcessed() {
        const selected = getSelectedNotifications();
        if (selected.length === 0) {
            alert('Veuillez sélectionner au moins une notification');
            return;
        }
        
        const csrfToken = getCookie('csrftoken');
        let successCount = 0;
        
        for (const id of selected) {
            try {
                const res = await fetch(`/notifications/${id}/marquer-traitee/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrfToken}
                });
                if (res.ok) successCount++;
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        if (successCount > 0) {
            location.reload();
        }
    }

    function archiveSelected() {
        const selected = getSelectedNotifications();
        if (selected.length === 0) {
            alert('Veuillez sélectionner au moins une notification');
            return;
        }
        
        if (confirm(`Êtes-vous sûr de vouloir archiver ${selected.length} notification(s) ?`)) {
            // Implémentation de l'archivage
            markSelectedAsProcessed(); // Pour l'instant, on les marque comme traitées
        }
    }

    async function showNotificationDetails(notificationId) {
        const modal = new bootstrap.Modal(document.getElementById('notificationDetailModal'));
        const content = document.getElementById('notificationDetailContent');
        
        content.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-2">Chargement des détails...</p>
            </div>
        `;
        
        modal.show();
        
        try {
            const res = await fetch(`/notifications/${notificationId}/details/`, {
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            });
            
            if (res.ok) {
                const data = await res.json();
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informations générales</h6>
                            <table class="table table-sm">
                                <tr><td><strong>ID:</strong></td><td>${data.id}</td></tr>
                                <tr><td><strong>Type:</strong></td><td>${data.type_display}</td></tr>
                                <tr><td><strong>Priorité:</strong></td><td>${data.priority_display}</td></tr>
                                <tr><td><strong>Date:</strong></td><td>${data.date_creation}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Message complet</h6>
                            <p>${data.message}</p>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des détails
                    </div>
                `;
            }
        } catch (error) {
            content.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Impossible de charger les détails. Veuillez réessayer.
                </div>
            `;
        }
    }

    // Fonctions pour répondre aux messages clients
    async function replyToClientMessage(notificationId) {
        const modal = new bootstrap.Modal(document.getElementById('replyToClientModal'));
        const detailsDiv = document.getElementById('clientMessageDetails');
        
        detailsDiv.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-2">Chargement du message...</p>
            </div>
        `;
        
        document.getElementById('messageId').value = notificationId;
        modal.show();
        
        try {
            const res = await fetch(`/notifications/contact-message/${notificationId}/details/`, {
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            });
            
            if (res.ok) {
                const data = await res.json();
                detailsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informations client</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Nom:</strong></td><td>${data.nom}</td></tr>
                                <tr><td><strong>Email:</strong></td><td>${data.email}</td></tr>
                                <tr><td><strong>Téléphone:</strong></td><td>${data.telephone || 'Non renseigné'}</td></tr>
                                <tr><td><strong>Date:</strong></td><td>${data.date_envoi}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Détails du message</h6>
                            <p><strong>Sujet:</strong> ${data.sujet}</p>
                            <p><strong>Urgence:</strong> 
                                <span class="badge bg-${data.urgence === 'critique' ? 'danger' : data.urgence === 'urgent' ? 'warning' : 'info'}">
                                    ${data.urgence_display}
                                </span>
                            </p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Message du client:</h6>
                        <div class="border rounded p-3 bg-light">
                            <p class="mb-0">${data.message}</p>
                        </div>
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement du message
                    </div>
                `;
            }
        } catch (error) {
            detailsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Impossible de charger le message. Veuillez réessayer.
                </div>
            `;
        }
    }

    async function sendReplyToClient() {
        const messageId = document.getElementById('messageId').value;
        const reponseText = document.getElementById('reponseText').value;
        const markAsResolved = document.getElementById('markAsResolved').checked;
        
        if (!reponseText.trim()) {
            alert('Veuillez saisir une réponse.');
            return;
        }
        
        const submitBtn = document.querySelector('#replyToClientModal .btn-primary');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Envoi en cours...';
        submitBtn.disabled = true;
        
        try {
            const res = await fetch('/notifications/reply-to-client/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    messageId: messageId,
                    reponse: reponseText,
                    markAsResolved: markAsResolved
                })
            });
            
            if (res.ok) {
                const data = await res.json();
                if (data.success) {
                    // Fermer le modal et recharger la page
                    bootstrap.Modal.getInstance(document.getElementById('replyToClientModal')).hide();
                    location.reload();
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur lors de l\'envoi'));
                }
            } else {
                alert('Erreur serveur lors de l\'envoi de la réponse.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Erreur réseau. Veuillez réessayer.');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-rafraîchissement des notifications critiques
        setInterval(() => {
            const criticalNotifications = document.querySelectorAll('.notification-card.critique.non-lue');
            if (criticalNotifications.length > 0) {
                // Optionnel: recharger automatiquement si des notifications critiques existent
                console.log('Notifications critiques détectées:', criticalNotifications.length);
            }
        }, 30000); // Toutes les 30 secondes
        
        // Gestion du bouton "Tout sélectionner"
        const selectAllCheckbox = document.createElement('input');
        selectAllCheckbox.type = 'checkbox';
        selectAllCheckbox.className = 'form-check-input me-2';
        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.notification-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        });
        
        // Ajouter le bouton "Tout sélectionner" avant les notifications
        const notificationContainer = document.querySelector('.col-12');
        if (notificationContainer) {
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'mb-2';
            selectAllDiv.innerHTML = '<label class="form-label"><strong>Tout sélectionner</strong></label>';
            selectAllDiv.prepend(selectAllCheckbox);
            notificationContainer.prepend(selectAllDiv);
        }
    });
</script>
{% endblock %}
