{% extends 'hotel/base.html' %}

{% block title %}Gérer mot de passe - Client{% endblock %}

{% block page_title %}
<i class="fas fa-key"></i>
<span>Gestion du mot de passe</span>
{% endblock %}

{% block content %}
<div class="password-manager-container">
    <div class="password-manager-card">
        <div class="password-manager-header">
            <div class="header-icon">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="header-content">
                <h2>Gestion du mot de passe</h2>
                <p class="client-info">
                    <i class="fas fa-user-circle"></i>
                    {{ client.nom_complet }}
                </p>
            </div>
        </div>
        
        <div class="password-manager-body">
            {% if not user %}
            <div class="alert alert-warning">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <strong>Aucun compte utilisateur</strong>
                    <p>Ce client n'a pas encore de compte utilisateur lié. Veuillez d'abord créer un compte.</p>
                </div>
            </div>
            {% endif %}
            
            <form method="post" class="password-form">
                {% csrf_token %}
                
                <div class="form-section">
                    <h3><i class="fas fa-lock"></i> Nouveau mot de passe</h3>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key"></i> Nouveau mot de passe
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="new_password" 
                                   id="newPassword"
                                   class="form-input" 
                                   {% if not user %}disabled{% endif %} 
                                   required
                                   placeholder="Saisir le nouveau mot de passe">
                            <button type="button" class="input-toggle" onclick="togglePassword('newPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="input-hint">
                            <i class="fas fa-info-circle"></i>
                            Minimum 8 caractères avec chiffres et lettres
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key"></i> Confirmer le mot de passe
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="confirm_password" 
                                   id="confirmPassword"
                                   class="form-input" 
                                   {% if not user %}disabled{% endif %} 
                                   required
                                   placeholder="Confirmer le mot de passe">
                            <button type="button" class="input-toggle" onclick="togglePassword('confirmPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Password strength indicator -->
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-label">Force du mot de passe :</div>
                        <div class="strength-bar">
                            <div class="strength-segment" id="segment1"></div>
                            <div class="strength-segment" id="segment2"></div>
                            <div class="strength-segment" id="segment3"></div>
                            <div class="strength-segment" id="segment4"></div>
                        </div>
                        <div class="strength-text" id="strengthText">Faible</div>
                    </div>
                    
                    <!-- Password requirements -->
                    <div class="requirements-card">
                        <h4><i class="fas fa-clipboard-check"></i> Exigences de sécurité</h4>
                        <ul class="requirements-list">
                            <li id="reqLength"><i class="fas fa-circle"></i> Minimum 8 caractères</li>
                            <li id="reqNumber"><i class="fas fa-circle"></i> Au moins un chiffre</li>
                            <li id="reqUpper"><i class="fas fa-circle"></i> Au moins une majuscule</li>
                            <li id="reqLower"><i class="fas fa-circle"></i> Au moins une minuscule</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-actions">
                    <a href="{% url 'client_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Retour à la liste
                    </a>
                    <button class="btn btn-primary {% if not user %}disabled{% endif %}" 
                            type="submit" 
                            {% if not user %}disabled{% endif %}>
                        <i class="fas fa-save"></i> Mettre à jour le mot de passe
                    </button>
                </div>
            </form>
        </div>
        
        <div class="password-manager-footer">
            <div class="security-info">
                <i class="fas fa-shield-alt"></i>
                <div>
                    <strong>Conseils de sécurité</strong>
                    <p>Utilisez un mot de passe unique que vous n'utilisez pas sur d'autres sites.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Styles spécifiques pour la gestion du mot de passe */
    .password-manager-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .password-manager-card {
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
    }
    
    .password-manager-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
        color: white;
        padding: 2rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }
    
    .header-icon {
        width: 70px;
        height: 70px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
    }
    
    .header-content h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        color: white;
    }
    
    .client-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        opacity: 0.9;
        font-size: 0.9rem;
    }
    
    .password-manager-body {
        padding: 2rem;
    }
    
    /* Alert styling */
    .alert {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1.2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        animation: slideIn 0.3s ease;
    }
    
    .alert-warning {
        background: rgba(243, 156, 18, 0.1);
        border: 1px solid rgba(243, 156, 18, 0.2);
        color: var(--warning-orange);
    }
    
    .alert-icon {
        font-size: 1.2rem;
        margin-top: 0.2rem;
    }
    
    .alert-content {
        flex: 1;
    }
    
    .alert-content strong {
        display: block;
        margin-bottom: 0.3rem;
    }
    
    .alert-content p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    /* Form styling */
    .form-section {
        margin-bottom: 2rem;
    }
    
    .form-section h3 {
        color: var(--primary-blue);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.2rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .input-group {
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .form-input {
        flex: 1;
        padding: 0.9rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: var(--transition);
        background: white;
    }
    
    .form-input:focus {
        border-color: var(--secondary-blue);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        outline: none;
    }
    
    .form-input:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .input-toggle {
        position: absolute;
        right: 10px;
        background: none;
        border: none;
        color: var(--text-light);
        cursor: pointer;
        padding: 0.5rem;
        transition: var(--transition);
    }
    
    .input-toggle:hover {
        color: var(--secondary-blue);
    }
    
    .input-hint {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Password strength indicator */
    .password-strength {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin: 1.5rem 0;
    }
    
    .strength-label {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }
    
    .strength-bar {
        display: flex;
        gap: 4px;
        margin: 0.5rem 0;
    }
    
    .strength-segment {
        flex: 1;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        transition: var(--transition);
    }
    
    .strength-text {
        font-size: 0.85rem;
        font-weight: 600;
        text-align: right;
    }
    
    /* Requirements list */
    .requirements-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .requirements-card h4 {
        color: var(--primary-blue);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
    }
    
    .requirements-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .requirements-list li {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-light);
    }
    
    .requirements-list li i {
        font-size: 0.5rem;
        transition: var(--transition);
    }
    
    .requirement-met {
        color: var(--success-green) !important;
    }
    
    .requirement-met i {
        color: var(--success-green) !important;
    }
    
    /* Form actions */
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 2rem;
        border-top: 1px solid #eee;
        margin-top: 2rem;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
    }
    
    .btn-primary {
        background: var(--secondary-blue);
        color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
        background: var(--accent-blue);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }
    
    .btn-secondary {
        background: #f8f9fa;
        color: var(--text-dark);
        border: 1px solid #dee2e6;
    }
    
    .btn-secondary:hover {
        background: #e9ecef;
        color: var(--primary-blue);
    }
    
    /* Footer */
    .password-manager-footer {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-top: 1px solid #eee;
    }
    
    .security-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: var(--text-light);
    }
    
    .security-info i {
        font-size: 1.2rem;
        color: var(--secondary-blue);
    }
    
    .security-info strong {
        display: block;
        color: var(--text-dark);
        margin-bottom: 0.2rem;
    }
    
    .security-info p {
        margin: 0;
        font-size: 0.9rem;
    }
    
    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Responsive */
    @media screen and (max-width: 768px) {
        .password-manager-header {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem;
        }
        
        .header-icon {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
        
        .password-manager-body {
            padding: 1.5rem;
        }
        
        .form-actions {
            flex-direction: column;
            gap: 1rem;
        }
        
        .form-actions .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<script>
    // Toggle password visibility
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const toggle = input.nextElementSibling;
        const icon = toggle.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
    
    // Password strength checker
    document.getElementById('newPassword').addEventListener('input', function(e) {
        const password = e.target.value;
        const strengthBar = document.getElementById('passwordStrength');
        const segments = document.querySelectorAll('.strength-segment');
        const strengthText = document.getElementById('strengthText');
        const requirements = {
            length: document.getElementById('reqLength'),
            number: document.getElementById('reqNumber'),
            upper: document.getElementById('reqUpper'),
            lower: document.getElementById('reqLower')
        };
        
        // Reset requirements
        Object.values(requirements).forEach(req => {
            req.classList.remove('requirement-met');
            req.querySelector('i').classList.remove('fa-check-circle');
            req.querySelector('i').classList.add('fa-circle');
        });
        
        // Check requirements
        let strength = 0;
        
        // Length requirement
        if (password.length >= 8) {
            strength++;
            requirements.length.classList.add('requirement-met');
            requirements.length.querySelector('i').classList.remove('fa-circle');
            requirements.length.querySelector('i').classList.add('fa-check-circle');
        }
        
        // Number requirement
        if (/\d/.test(password)) {
            strength++;
            requirements.number.classList.add('requirement-met');
            requirements.number.querySelector('i').classList.remove('fa-circle');
            requirements.number.querySelector('i').classList.add('fa-check-circle');
        }
        
        // Uppercase requirement
        if (/[A-Z]/.test(password)) {
            strength++;
            requirements.upper.classList.add('requirement-met');
            requirements.upper.querySelector('i').classList.remove('fa-circle');
            requirements.upper.querySelector('i').classList.add('fa-check-circle');
        }
        
        // Lowercase requirement
        if (/[a-z]/.test(password)) {
            strength++;
            requirements.lower.classList.add('requirement-met');
            requirements.lower.querySelector('i').classList.remove('fa-circle');
            requirements.lower.querySelector('i').classList.add('fa-check-circle');
        }
        
        // Update strength bar
        segments.forEach((segment, index) => {
            segment.style.background = index < strength ? getStrengthColor(strength) : '#e0e0e0';
        });
        
        // Update strength text
        const strengthLabels = ['Très faible', 'Faible', 'Moyen', 'Fort', 'Très fort'];
        strengthText.textContent = password.length === 0 ? 'Faible' : strengthLabels[strength];
        strengthText.style.color = getStrengthColor(strength);
    });
    
    function getStrengthColor(strength) {
        switch(strength) {
            case 0:
            case 1:
                return '#e74c3c'; // Red
            case 2:
                return '#f39c12'; // Orange
            case 3:
                return '#f1c40f'; // Yellow
            case 4:
                return '#2ecc71'; // Green
            default:
                return '#e0e0e0';
        }
    }
    
    // Form validation
    document.querySelector('.password-form').addEventListener('submit', function(e) {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('Les mots de passe ne correspondent pas.');
            return;
        }
        
        if (newPassword.length < 8) {
            e.preventDefault();
            alert('Le mot de passe doit contenir au moins 8 caractères.');
            return;
        }
    });
</script>
{% endblock %}