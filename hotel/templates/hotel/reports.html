{% extends 'hotel/base.html' %}
{% load humanize %}

{% block title %}Tableau de Bord - Hôtel{% endblock %}

{% block extra_css %}
<style>
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 10px;
}

.kpi-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    border-left: 4px solid;
    margin-bottom: 1.5rem;
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.2);
}

.kpi-card.commercial { border-left-color: #007bff; }
.kpi-card.financier { border-left-color: #28a745; }
.kpi-card.operationnel { border-left-color: #ffc107; }

.kpi-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 0.5rem 0;
}

.kpi-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.kpi-trend {
    font-size: 0.8rem;
    margin-top: 0.5rem;
}

.trend-up { color: #28a745; }
.trend-down { color: #dc3545; }
.trend-neutral { color: #6c757d; }

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-title i {
    font-size: 1.1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.progress-bar-container {
    background: #e9ecef;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.progress-bar-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.badge-status {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.period-selector {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.reservation-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: #495057;
}

.stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.alert-info-custom {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .reservation-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Header du tableau de bord -->
<div class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-chart-line me-2"></i>
                    Tableau de Bord Performance
                </h1>
                <p class="mb-0 opacity-75">
                    Vue d'ensemble des indicateurs clés de l'hôtel
                    {% if period == 'day' %}- Aujourd'hui{% elif period == 'month' %}- Ce mois{% else %}- Cette année{% endif %}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <small class="d-block opacity-75">
                    <i class="fas fa-calendar me-1"></i>
                    {{ period_start|date:"d/m/Y" }} - {{ period_end|date:"d/m/Y" }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Sélecteur de période -->
<div class="container">
    <div class="period-selector">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Période d'analyse
                </h5>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="btn-group" role="group">
                    <a href="?period=day" class="btn btn-outline-primary {% if period == 'day' %}active{% endif %}">
                        <i class="fas fa-calendar-day me-1"></i>Aujourd'hui
                    </a>
                    <a href="?period=month" class="btn btn-outline-primary {% if period == 'month' %}active{% endif %}">
                        <i class="fas fa-calendar-alt me-1"></i>Ce mois
                    </a>
                    <a href="?period=year" class="btn btn-outline-primary {% if period == 'year' %}active{% endif %}">
                        <i class="fas fa-calendar me-1"></i>Cette année
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- PERFORMANCE COMMERCIALE -->
    <section class="mb-4">
        <h2 class="section-title">
            <i class="fas fa-shopping-cart text-primary"></i>
            Performance Commerciale
        </h2>
        
        <div class="stats-grid">
            <!-- Taux d'occupation -->
            <div class="kpi-card commercial" role="button" tabindex="0"
                 data-title="Taux d'occupation"
                 data-body="{{ performance_commerciale.chambres_occupees }} chambres occupées sur {{ performance_commerciale.chambres_total }} ({{ performance_commerciale.taux_occupation }}%)"
                 data-link="{% url 'reservation_list' %}?status=confirmee,en_cours&period={{ period }}">
                <div class="kpi-label">
                    <i class="fas fa-bed me-1"></i>
                    Taux d'occupation
                </div>
                <div class="kpi-value text-primary">
                    {{ performance_commerciale.taux_occupation }}%
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill bg-primary" style="width: {{ performance_commerciale.taux_occupation }}%"></div>
                </div>
                <div class="kpi-trend">
                    {{ performance_commerciale.chambres_occupees }}/{{ performance_commerciale.chambres_total }} chambres
                </div>
            </div>

            <!-- RevPAR -->
            <div class="kpi-card commercial" role="button" tabindex="0"
                 data-title="RevPAR"
                 data-body="RevPAR: {{ performance_commerciale.revpar|floatformat:2 }} € (revenu par chambre disponible)"
                 data-link="{% url 'billing_list' %}?period={{ period }}">
                <div class="kpi-label">
                    <i class="fas fa-euro-sign me-1"></i>
                    RevPAR (Revenue Per Available Room)
                </div>
                <div class="kpi-value text-info">
                    {{ performance_commerciale.revpar|floatformat:2 }} €
                </div>
                <div class="kpi-trend trend-neutral">
                    <i class="fas fa-info-circle me-1"></i>
                    Revenu par chambre disponible
                </div>
            </div>

            <!-- Revenus période -->
            <div class="kpi-card commercial" role="button" tabindex="0"
                 data-title="Revenus période"
                 data-body="Revenus basés sur réservations: {{ performance_commerciale.revenue_period|floatformat:2|intcomma }} €"
                 data-link="{% url 'billing_list' %}?period={{ period }}">
                <div class="kpi-label">
                    <i class="fas fa-chart-line me-1"></i>
                    Revenus période
                </div>
                <div class="kpi-value text-success">
                    {{ performance_commerciale.revenue_period|floatformat:2|intcomma }} €
                </div>
                <div class="kpi-trend">
                    <i class="fas fa-arrow-up me-1"></i>
                    Basé sur les réservations confirmées
                </div>
            </div>

            <!-- Total réservations -->
            <div class="kpi-card commercial" role="button" tabindex="0"
                 data-title="Total Réservations"
                 data-body="Total réservations: {{ performance_commerciale.total_reservations.total|intcomma }}"
                 data-link="{% url 'reservation_list' %}?period={{ period }}">
                <div class="kpi-label">
                    <i class="fas fa-calendar-check me-1"></i>
                    Total Réservations
                </div>
                <div class="kpi-value text-warning">
                    {{ performance_commerciale.total_reservations.total|intcomma }}
                </div>
                <div class="kpi-trend">
                    <i class="fas fa-list me-1"></i>
                    Toutes périodes confondues
                </div>
            </div>
        </div>

        <!-- Détail des réservations par statut -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie me-2"></i>
                    Répartition des Réservations
                </h5>
                <div class="reservation-stats">
                    <div class="stat-item">
                        <div class="stat-number text-success">{{ performance_commerciale.total_reservations.confirmee|intcomma }}</div>
                        <div class="stat-label">Confirmées</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-primary">{{ performance_commerciale.total_reservations.en_cours|intcomma }}</div>
                        <div class="stat-label">En cours</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-info">{{ performance_commerciale.total_reservations.terminee|intcomma }}</div>
                        <div class="stat-label">Terminées</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-danger">{{ performance_commerciale.total_reservations.annulee|intcomma }}</div>
                        <div class="stat-label">Annulées</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- PERFORMANCE FINANCIÈRE (Admin seulement) -->
    {% if is_admin and performance_financiere %}
    <section class="mb-4">
        <h2 class="section-title">
            <i class="fas fa-euro-sign text-success"></i>
            Performance Financière
            <small class="text-muted">(Accès administrateur)</small>
        </h2>
        
        <div class="stats-grid">
            <!-- Revenus réels -->
            <div class="kpi-card financier">
                <div class="kpi-label">
                    <i class="fas fa-money-bill-wave me-1"></i>
                    Revenus Réels
                </div>
                <div class="kpi-value text-success">
                    {{ performance_financiere.revenus_reels|floatformat:2|intcomma }} €
                </div>
                <div class="kpi-trend">
                    <i class="fas fa-check-circle me-1"></i>
                    Basé sur les paiements confirmés
                </div>
            </div>

            <!-- Revenus estimés -->
            <div class="kpi-card financier">
                <div class="kpi-label">
                    <i class="fas fa-chart-bar me-1"></i>
                    Revenus Estimés
                </div>
                <div class="kpi-value text-info">
                    {{ performance_financiere.revenus_estimes|floatformat:2|intcomma }} €
                </div>
                <div class="kpi-trend">
                    <i class="fas fa-calculator me-1"></i>
                    Basé sur les réservations
                </div>
            </div>

            <!-- Charges totales -->
            <div class="kpi-card financier">
                <div class="kpi-label">
                    <i class="fas fa-receipt me-1"></i>
                    Charges Totales
                </div>
                <div class="kpi-value text-danger">
                    {{ performance_financiere.charges_totales|floatformat:2|intcomma }} €
                </div>
                <div class="kpi-trend">
                    <i class="fas fa-arrow-down me-1"></i>
                    Salaires + Maintenance + Autres
                </div>
            </div>

            <!-- Bénéfice estimé -->
            <div class="kpi-card financier">
                <div class="kpi-label">
                    <i class="fas fa-piggy-bank me-1"></i>
                    Bénéfice Estimé
                </div>
                <div class="kpi-value {% if performance_financiere.benefice_estime > 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ performance_financiere.benefice_estime|floatformat:2|intcomma }} €
                </div>
                <div class="kpi-trend {% if performance_financiere.benefice_estime > 0 %}trend-up{% else %}trend-down{% endif %}">
                    {% if performance_financiere.benefice_estime > 0 %}
                        <i class="fas fa-arrow-up me-1"></i>Positif
                    {% else %}
                        <i class="fas fa-arrow-down me-1"></i>Négatif
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Détail des charges -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie me-2"></i>
                    Répartition des Charges
                </h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="stat-item">
                            <div class="stat-number text-warning">{{ performance_financiere.salaires|floatformat:0|intcomma }} €</div>
                            <div class="stat-label">Salaires</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <div class="stat-number text-info">{{ performance_financiere.maintenance|floatformat:0|intcomma }} €</div>
                            <div class="stat-label">Maintenance</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <div class="stat-number text-secondary">{{ performance_financiere.autres_charges|floatformat:0|intcomma }} €</div>
                            <div class="stat-label">Autres charges</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- PERFORMANCE OPÉRATIONNELLE -->
    <section class="mb-4">
        <h2 class="section-title">
            <i class="fas fa-cogs text-warning"></i>
            Performance Opérationnelle
        </h2>
        
        <div class="stats-grid">
            <!-- Total clients -->
            <div class="kpi-card operationnel">
                <div class="kpi-label">
                    <i class="fas fa-users me-1"></i>
                    Total Clients
                </div>
                <div class="kpi-value text-primary">
                    {{ performance_operationnelle.total_clients|intcomma }}
                </div>
                <div class="kpi-trend">
                    <i class="fas fa-user-friends me-1"></i>
                    Base de clients totale
                </div>
            </div>

            <!-- Nouveaux clients mois -->
            <div class="kpi-card operationnel">
                <div class="kpi-label">
                    <i class="fas fa-user-plus me-1"></i>
                    Nouveaux Clients (mois)
                </div>
                <div class="kpi-value text-success">
                    {{ performance_operationnelle.nouveaux_clients_mois|intcomma }}
                </div>
                <div class="kpi-trend trend-up">
                    <i class="fas fa-arrow-up me-1"></i>
                    Croissance clientèle
                </div>
            </div>

            <!-- Maintenance en attente -->
            <div class="kpi-card operationnel">
                <div class="kpi-label">
                    <i class="fas fa-tools me-1"></i>
                    Maintenance en attente
                </div>
                <div class="kpi-value text-warning">
                    {{ performance_operationnelle.maintenance.en_attente }}
                </div>
                <div class="kpi-trend">
                    <i class="fas fa-clock me-1"></i>
                    Interventions à planifier
                </div>
            </div>

            <!-- Total employés -->
            <div class="kpi-card operationnel">
                <div class="kpi-label">
                    <i class="fas fa-user-tie me-1"></i>
                    Total Employés
                </div>
                <div class="kpi-value text-info">
                    {{ performance_operationnelle.total_employes }}
                </div>
                <div class="kpi-trend">
                    <i class="fas fa-users me-1"></i>
                    Équipe active
                </div>
            </div>
        </div>

        <!-- Détail maintenance -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-wrench me-2"></i>
                    Suivi Maintenance
                </h5>
                <div class="reservation-stats">
                    <div class="stat-item">
                        <div class="stat-number text-warning">{{ performance_operationnelle.maintenance.en_attente }}</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-primary">{{ performance_operationnelle.maintenance.en_cours }}</div>
                        <div class="stat-label">En cours</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-success">{{ performance_operationnelle.maintenance.terminee }}</div>
                        <div class="stat-label">Terminées</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-info">{{ performance_operationnelle.maintenance.cout_mois|floatformat:0|intcomma }} €</div>
                        <div class="stat-label">Coût mois</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Alertes et informations -->
    {% if not is_admin %}
    <div class="alert-info-custom">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Accès limité :</strong> Certaines informations financières détaillées sont réservées aux administrateurs. 
        Contactez votre superviseur pour plus d'informations.
    </div>
    {% endif %}

    <!-- Section exports (préparation pour future implémentation) -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">
                <i class="fas fa-download me-2"></i>
                Exports et Rapports
            </h5>
            <p class="text-muted mb-3">
                Fonctionnalités d'export à venir : CSV, PDF, graphiques interactifs
            </p>
            <div class="btn-group">
                <button class="btn btn-outline-secondary" disabled>
                    <i class="fas fa-file-csv me-1"></i>Exporter CSV
                </button>
                <button class="btn btn-outline-secondary" disabled>
                    <i class="fas fa-file-pdf me-1"></i>Exporter PDF
                </button>
                <button class="btn btn-outline-secondary" disabled>
                    <i class="fas fa-chart-area me-1"></i>Graphiques
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Details modal for KPI cards -->
<div class="modal fade" id="kpiDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="kpiDetailTitle">Détails</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="kpiDetailBody">Chargement...</div>
      <div class="modal-footer">
        <a href="#" id="kpiDetailLink" class="btn btn-primary">Voir détails</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- Placeholder pour futurs graphiques -->
<div class="container mt-4">
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Graphiques interactifs bientôt disponibles</h5>
            <p class="text-muted">
                Évolution des revenus, taux d'occupation, et autres indicateurs visuels
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Fonctionnalités JavaScript pour le tableau de bord
document.addEventListener('DOMContentLoaded', function() {
    // Animation des compteurs
    const counters = document.querySelectorAll('.kpi-value');
    
    counters.forEach(counter => {
        const target = parseFloat(counter.textContent.replace(/[^0-9.-]/g, ''));
        const isPercentage = counter.textContent.includes('%');
        const isEuro = counter.textContent.includes('€');
        
        if (!isNaN(target)) {
            let current = 0;
            const increment = target / 50;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                
                if (isPercentage) {
                    counter.textContent = current.toFixed(1) + '%';
                } else if (isEuro) {
                    counter.textContent = current.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' €';
                } else {
                    counter.textContent = Math.floor(current).toLocaleString();
                }
            }, 20);
        }
    });
    
    // Gestion des filtres de période
    const periodButtons = document.querySelectorAll('.btn-group .btn');
    periodButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            // Ajouter un effet de chargement
            document.body.style.cursor = 'wait';
        });
    });
    
    // Tooltip pour les KPIs
    const kpiCards = document.querySelectorAll('.kpi-card');
    kpiCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });

        // Click to open modal with details if data-* attributes present
        card.addEventListener('click', function() {
            const title = this.dataset.title || 'Détails';
            const body = this.dataset.body || '';
            const link = this.dataset.link || '#';
            const modalEl = document.getElementById('kpiDetailModal');
            const titleEl = document.getElementById('kpiDetailTitle');
            const bodyEl = document.getElementById('kpiDetailBody');
            const linkEl = document.getElementById('kpiDetailLink');

            titleEl.textContent = title;
            bodyEl.textContent = body;
            linkEl.href = link;

            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        });

        // Allow keyboard activation (enter/space)
        card.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
});

// Fonction pour rafraîchir les données (préparation pour AJAX)
function refreshDashboard() {
    // Placeholder pour future implémentation de rafraîchissement automatique
    console.log('Rafraîchissement du tableau de bord...');
}
</script>
{% endblock %}
