{% extends 'hotel/base.html' %}

{% block page_title %}
<i class="fas fa-calendar-alt"></i>
<span>Calendrier des réservations</span>
{% endblock %}

{% block extra_css %}
<style>
/* Main container */
.calendar-container {
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    min-height: 100vh;
}

/* Header styling */
.calendar-header {
    background: white;
    border-radius: 16px;
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

/* Toolbar styling */
.calendar-toolbar {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-radius: 12px;
    color: white;
}

.calendar-toolbar a {
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s;
}

.calendar-toolbar a:hover {
    transform: scale(1.1);
}

#currentMonth {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 1rem;
    text-transform: capitalize;
    letter-spacing: 0.5px;
}

.btn-month {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-month:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

/* Filters card - Modern redesign */
.filters-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: 0 6px 25px rgba(30, 41, 59, 0.08);
    border: 1px solid #f1f5f9;
    backdrop-filter: blur(10px);
    margin-bottom: 1.5rem;
}

.filters-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

.filters-row .form-control,
.filters-row .form-select {
    min-width: 160px;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s;
    background: #f8fafc;
}

.filters-row .form-control:focus,
.filters-row .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    background: white;
}

.btn-filter {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
    cursor: pointer;
}

.btn-filter:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
}

/* Add reservation button */
.btn-add-reservation {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
    border: none;
    padding: 0.875rem 1.75rem;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s;
    text-decoration: none;
}

.btn-add-reservation:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
    color: white;
}

/* Calendar table - Modern redesign */
.calendar-wrapper {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    border: 1px solid #f1f5f9;
    overflow: hidden;
}

.calendar-table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    background: white;
}

.calendar-table thead th {
    background: #f8fafc;
    padding: 1.25rem 0.75rem;
    font-weight: 700;
    color: #334155;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e2e8f0;
}

.calendar-table thead th:first-child {
    border-radius: 12px 0 0 0;
}

.calendar-table thead th:last-child {
    border-radius: 0 12px 0 0;
}

.calendar-table th,
.calendar-table td {
    text-align: center;
    vertical-align: middle;
    padding: 0.75rem;
}

.calendar-table td {
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.2s;
    height: 100px;
    position: relative;
}

.calendar-table td:hover {
    background-color: #f8fafc;
}

/* Room cell styling */
.room-cell {
    text-align: left;
    padding-left: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    width: 200px;
    background: #f8fafc;
    position: sticky;
    left: 0;
    z-index: 10;
    border-right: 2px solid #e2e8f0;
}

/* Day cell styling */
.day-cell {
    min-width: 100px;
    position: relative;
}

.day-number {
    font-size: 1.1rem;
    font-weight: 700;
    color: #334155;
    margin-bottom: 0.25rem;
}

.day-name {
    font-size: 0.85rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Reservation block - Modern redesign */
.reservation-block {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 10px;
    font-size: 0.85rem;
    padding: 0.75rem;
    display: block;
    width: calc(100% - 8px);
    margin: 2px 4px;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    position: absolute;
    top: 4px;
    left: 4px;
    right: 4px;
    z-index: 5;
    border: none;
}

.reservation-block:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    z-index: 20;
}

.reservation-block strong {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.reservation-block small {
    display: block;
    opacity: 0.9;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Status colors with gradients */
.reservation-block.bg-success {
    background: linear-gradient(135deg, #10b981, #059669);
    border-left: 4px solid #059669;
}

.reservation-block.bg-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-left: 4px solid #1d4ed8;
}

.reservation-block.bg-secondary {
    background: linear-gradient(135deg, #64748b, #475569);
    border-left: 4px solid #475569;
}

.reservation-block.bg-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-left: 4px solid #dc2626;
}

/* Empty cell */
.empty-cell {
    height: 100px;
    background: transparent;
}

/* Legend - Modern redesign */
.legend-container {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
}

.legend-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #334155;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.legend-items {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.legend-badge {
    padding: 0.75rem 1.25rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: transform 0.2s;
}

.legend-badge:hover {
    transform: translateY(-2px);
}

.legend-badge.confirmée {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
    color: #059669;
    border: 2px solid #10b981;
}

.legend-badge.en-cours {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1));
    color: #1d4ed8;
    border: 2px solid #3b82f6;
}

.legend-badge.terminée {
    background: linear-gradient(135deg, rgba(100, 116, 139, 0.1), rgba(71, 85, 105, 0.1));
    color: #475569;
    border: 2px solid #64748b;
}

.legend-badge.indisponible {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
    color: #dc2626;
    border: 2px solid #ef4444;
}

/* Custom modal - Enhanced design */
.custom-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(5px);
    }
}

.custom-modal.open {
    display: flex;
}

.custom-modal-dialog {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden;
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.custom-modal .modal-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e2e8f0;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.custom-modal .modal-header h5 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
}

.custom-modal .modal-body {
    padding: 2rem;
}

.custom-modal .modal-footer {
    padding: 1.5rem 2rem;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    background: #f8fafc;
}

.btn-close-custom {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 10px;
    color: white;
    font-size: 1.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.btn-close-custom:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

/* List group items */
.list-group-item {
    border: none;
    padding: 1rem 0;
    background: transparent;
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
}

.list-group-item:last-child {
    border-bottom: none;
}

.list-group-item b {
    color: #1e293b;
    font-weight: 700;
    min-width: 100px;
    display: inline-block;
}

/* Action buttons in modal */
.btn-action {
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
}

.btn-action.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.btn-action.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
}

.btn-action.btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.btn-action.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
}

.btn-action.btn-secondary {
    background: linear-gradient(135deg, #64748b, #475569);
    color: white;
}

.btn-action.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(100, 116, 139, 0.3);
}

/* Responsive design */
@media (max-width: 1200px) {
    .calendar-container {
        padding: 1rem;
    }
    
    .calendar-wrapper {
        padding: 1rem;
        overflow-x: auto;
    }
    
    .calendar-table {
        min-width: 1000px;
    }
}

@media (max-width: 768px) {
    .calendar-container {
        padding: 1rem 0.5rem;
    }
    
    .header-top {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .calendar-toolbar {
        justify-content: center;
        padding: 0.75rem;
    }
    
    #currentMonth {
        font-size: 1.25rem;
        margin: 0 0.5rem;
    }
    
    .filters-row {
        flex-direction: column;
    }
    
    .filters-row .form-control,
    .filters-row .form-select {
        width: 100%;
    }
    
    .legend-items {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .custom-modal-dialog {
        margin: 1rem;
        max-width: calc(100% - 2rem);
    }
}

@media (max-width: 480px) {
    .calendar-toolbar {
        gap: 0.5rem;
    }
    
    .btn-month {
        width: 36px;
        height: 36px;
    }
    
    .btn-add-reservation,
    .btn-filter {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }
    
    .legend-badge {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- Header -->
    <div class="calendar-header">
        <div class="header-top">
            <div class="calendar-toolbar">
                <a href="#" id="prevMonth" class="btn-month">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <h4 class="mb-0" id="currentMonth">{{ days_in_month.0|date:"F Y" }}</h4>
                <a href="#" id="nextMonth" class="btn-month">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </div>
            <a href="{% url 'reservation_create' %}" class="btn-add-reservation">
                <i class="fas fa-plus"></i> Ajouter une réservation
            </a>
        </div>

        <!-- Filtres -->
        <form method="get">
            <div class="filters-card">
                <div class="filters-row">
                    <input type="date" name="date" class="form-control" value="{{ date_filter }}">
                    <select name="chambre" class="form-select">
                        <option value="">Toutes les chambres</option>
                        {% for chambre in chambres %}
                        <option value="{{ chambre.numero }}" {% if chambre.numero|stringformat:"s" == chambre_filter %}selected{% endif %}>
                            Chambre {{ chambre.numero }}
                        </option>
                        {% endfor %}
                    </select>
                    <select name="client" class="form-select">
                        <option value="">Tous les clients</option>
                        {% for client in clients %}
                        <option value="{% if client.nom %}{{ client.nom }}{% else %}{{ client.nom_complet }}{% endif %}" 
                                {% if client.nom and client.nom == client_filter or client.nom_complet and client.nom_complet == client_filter %}selected{% endif %}>
                            {% if client.nom %}{{ client.nom }}{% if client.prenom %} {{ client.prenom }}{% endif %}{% else %}{{ client.nom_complet }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <select name="statut" class="form-select">
                        <option value="">Tous statuts</option>
                        <option value="confirmée" {% if statut_filter == 'confirmée' %}selected{% endif %}>Confirmée</option>
                        <option value="en cours" {% if statut_filter == 'en cours' %}selected{% endif %}>En cours</option>
                        <option value="terminée" {% if statut_filter == 'terminée' %}selected{% endif %}>Terminée</option>
                    </select>
                    <input type="text" name="search" class="form-control" placeholder="Recherche rapide..." value="{{ search }}">
                    <button type="submit" class="btn-filter">
                        <i class="fas fa-filter"></i> Filtrer
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Calendrier mensuel -->
    <div class="calendar-wrapper">
        <div class="table-responsive">
            <table class="table calendar-table align-middle">
                <thead>
                    <tr>
                        <th class="room-cell">Chambre</th>
                        {% for day in days_in_month %}
                        <th class="text-center">
                            <div class="day-number">{{ day|date:"d" }}</div>
                            <div class="day-name">{{ day|date:"D" }}</div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for chambre in chambres %}
                    <tr>
                        <td class="room-cell">Chambre {{ chambre.numero }}</td>
                        {% for day in days_in_month %}
                        <td class="day-cell">
                            <div class="empty-cell"></div>
                            {% for res in reservations %}
                                {% if res.chambre.id == chambre.id and day >= res.date_entree and day <= res.date_sortie %}
                                    <div class="reservation-block text-white rounded
                                        {% if res.statut == 'confirmée' %}bg-success
                                        {% elif res.statut == 'en cours' %}bg-primary
                                        {% elif res.statut == 'terminée' %}bg-secondary
                                        {% else %}bg-danger{% endif %}"
                                        role="button" data-modal-target="#reservationModal{{ res.id }}">
                                        <strong>
                                            {% if res.client.nom %}
                                                {{ res.client.nom }}
                                                {% if res.client.prenom %} {{ res.client.prenom }}{% endif %}
                                            {% else %}
                                                {{ res.client.nom_complet }}
                                            {% endif %}
                                        </strong>
                                        <small>{{ res.date_entree|date:"d/m" }} → {{ res.date_sortie|date:"d/m" }}</small>
                                    </div>

                                    <!-- Modal détail réservation -->
                                    <div class="custom-modal" id="reservationModal{{ res.id }}" aria-hidden="true">
                                        <div class="custom-modal-dialog">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Réservation #{{ res.id }}</h5>
                                                <button class="btn-close-custom" data-modal-close aria-label="Fermer">×</button>
                                            </div>
                                            <div class="modal-body">
                                                <ul class="list-group">
                                                    <li class="list-group-item">
                                                        <b>Client :</b> 
                                                        {% if res.client.nom %}
                                                            {{ res.client.nom }}
                                                            {% if res.client.prenom %} {{ res.client.prenom }}{% endif %}
                                                        {% else %}
                                                            {{ res.client.nom_complet }}
                                                        {% endif %}
                                                    </li>
                                                    <li class="list-group-item"><b>Chambre :</b> {{ res.chambre.numero }}</li>
                                                    <li class="list-group-item"><b>Entrée :</b> {{ res.date_entree|date:"d/m/Y" }}</li>
                                                    <li class="list-group-item"><b>Sortie :</b> {{ res.date_sortie|date:"d/m/Y" }}</li>
                                                    <li class="list-group-item"><b>Statut :</b> {{ res.statut }}</li>
                                                </ul>
                                            </div>
                                            <div class="modal-footer">
                                                <a href="{% url 'reservation_update' res.id %}" class="btn-action btn-primary">
                                                    <i class="fas fa-edit"></i> Modifier
                                                </a>
                                                <a href="{% url 'reservation_delete' res.id %}" class="btn-action btn-danger">
                                                    <i class="fas fa-times"></i> Annuler
                                                </a>
                                                <button class="btn-action btn-secondary" data-modal-close>Fermer</button>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Légende -->
    <div class="legend-container">
        <div class="legend-title">
            <i class="fas fa-info-circle"></i>
            <span>Légende des statuts</span>
        </div>
        <div class="legend-items">
            <div class="legend-badge confirmée">
                <div class="status-dot" style="background: #10b981; width: 12px; height: 12px; border-radius: 50%;"></div>
                <span>Confirmée</span>
            </div>
            <div class="legend-badge en-cours">
                <div class="status-dot" style="background: #3b82f6; width: 12px; height: 12px; border-radius: 50%;"></div>
                <span>En cours</span>
            </div>
            <div class="legend-badge terminée">
                <div class="status-dot" style="background: #64748b; width: 12px; height: 12px; border-radius: 50%;"></div>
                <span>Terminée</span>
            </div>
            <div class="legend-badge indisponible">
                <div class="status-dot" style="background: #ef4444; width: 12px; height: 12px; border-radius: 50%;"></div>
                <span>Indisponible</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    // Month navigation
    const prev = document.getElementById('prevMonth');
    const next = document.getElementById('nextMonth');
    const dateInput = document.querySelector('input[name="date"]');

    function shiftMonth(dir){
        try{
            const d = new Date(dateInput.value || new Date());
            d.setMonth(d.getMonth() + dir);
            const y = d.getFullYear();
            const m = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            dateInput.value = `${y}-${m}-${day}`;
            dateInput.form.submit();
        } catch(e) { 
            console.warn('Navigation error:', e); 
        }
    }
    
    if(prev) prev.addEventListener('click', function(e){ 
        e.preventDefault(); 
        shiftMonth(-1); 
    });
    
    if(next) next.addEventListener('click', function(e){ 
        e.preventDefault(); 
        shiftMonth(1); 
    });

    // Custom modal handling
    document.querySelectorAll('[data-modal-target]').forEach(btn => {
        btn.addEventListener('click', function(e){
            const selector = this.getAttribute('data-modal-target');
            const modal = document.querySelector(selector);
            if(modal) {
                modal.classList.add('open');
                document.body.style.overflow = 'hidden';
            }
        });
    });

    document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', function(e){
            const modal = this.closest('.custom-modal');
            if(modal) {
                modal.classList.remove('open');
                document.body.style.overflow = '';
            }
        });
    });

    document.querySelectorAll('.custom-modal').forEach(modal => {
        modal.addEventListener('click', function(e){ 
            if(e.target === modal) {
                modal.classList.remove('open');
                document.body.style.overflow = '';
            }
        });
    });

    // Add hover effect to reservation blocks
    document.querySelectorAll('.reservation-block').forEach(block => {
        block.addEventListener('mouseenter', function() {
            this.style.zIndex = '999';
        });
        
        block.addEventListener('mouseleave', function() {
            this.style.zIndex = '';
        });
    });
});
</script>
{% endblock %}